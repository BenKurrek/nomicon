<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Nearnomicon</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Implementation details of the NearProtocol client">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="mermaid.css">
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="index.html">Introduction</a></li><li><a href="Network/Network.html"><strong aria-hidden="true">1.</strong> Network</a></li><li><ol class="section"><li><a href="Network/PeerManagement.html"><strong aria-hidden="true">1.1.</strong> Peer Management</a></li><li><a href="Network/TransactionPropagation.html"><strong aria-hidden="true">1.2.</strong> Transaction Propagation</a></li></ol></li><li><a href="Nightshade/Nightshade.html"><strong aria-hidden="true">2.</strong> Nightshade</a></li><li><ol class="section"><li><a href="Nightshade/VerifyError.html"><strong aria-hidden="true">2.1.</strong> State Verifying Errors</a></li><li><a href="Nightshade/Cryptography.html"><strong aria-hidden="true">2.2.</strong> Cryptography</a></li></ol></li><li><a href="DataStructures/DataStructures.html"><strong aria-hidden="true">3.</strong> Data Structures</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Nearnomicon</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#the-nearnomicon" id="the-nearnomicon"><h1>The Nearnomicon</h1></a>
<p>Nearnomicon contains the following information about the components of the NearProtocol client, with the goal to help
with the collaboration:</p>
<ul>
<li>High-level overview of the components and how they interact, including APIs;</li>
<li>Data-structures;</li>
<li>Things that are not yet implemented or replaced with temporary solutions;</li>
<li>Assumptions that each component makes.</li>
</ul>
<a class="header" href="#network" id="network"><h1>Network</h1></a>
<p>The network crate has two levels of abstractions:</p>
<ol>
<li><strong>Peer management</strong> is a low-level code that only works with discovering peers and connecting to them. It is not domain-specific, meaning it does not care about the content of the messages that it receives from the peers;</li>
<li><strong>Protocol</strong> is a higher-level code that understands the content of incoming and outgoing messages and communicates them with the corresponding parts of the infrastructure.</li>
</ol>
<a class="header" href="#current-state" id="current-state"><h2>Current state</h2></a>
<p>Our current implementation of the network is the minimal one for running nodes locally, on AWS, or in integration tests.
It contains the following functionality:</p>
<ul>
<li><strong>Peer discovery through the gossip.</strong> Peers periodically exchange information with each other about other peers that they know allowing all peers to gradually discover each other;</li>
<li><strong>Booting from the boot nodes.</strong> Peers start discovering of other peers by initially connecting to the boot nodes;</li>
<li><strong>Handshake.</strong> Peers that establish the connection with each other are required to perform a handshake that involves exchanging certain information, like information about other peers;</li>
<li><strong>Unique connection.</strong> We guarantee that there is at most one connection between two peers, by breaking a tie when they try to connect to each other simultaneously;</li>
<li><strong>Timeouts.</strong> Certain operations, like establishing a connection or performing a handshake are limited by a timeout;</li>
<li><strong>Reconnection.</strong> Peers that have some connections dropped will try to re-establish them after a certain period of time.</li>
</ul>
<p>The following functionality is not implemented yet:</p>
<ul>
<li><strong>Relays.</strong> The peers that are behind the NAT cannot have a direct communication and have to use relays. Our current code does not implement that;</li>
<li><strong>Broadcasting.</strong> We need a broadcasting for announcements over the network;</li>
<li><strong>Encryption.</strong> Currently our messages are not encrypted;</li>
<li><strong>Verification.</strong> During the handshake we should verify that the other peer is not an impostor, by verifying their signed handshake;</li>
<li><strong>Connection limit.</strong> We need to limit the number of connections a single peer can have. When we try to establish a connection with a maxed-out boot node it should redirect us to other nodes;</li>
<li><strong>Tight coupling between gossip and relaying.</strong> Our consensus algorithms use gossip, since we want them to adversary-proof the relaying should be adversary-proof too.</li>
<li><strong>DNS.</strong> DNS resolution.</li>
</ul>
<a class="header" href="#peer-management" id="peer-management"><h1>Peer Management</h1></a>
<p>As discussed before, peer management takes care of peers and does not work with the content of the
messages sent between the peers.</p>
<p>Each peer in peer management is represented by a state-machine, represented by <code>Peer</code> object. Peer can then be in
multiple states:</p>
<ul>
<li><strong>Unconnected</strong> -- we know that peer's info but we have not established a connection yet;</li>
<li><strong>Connecting</strong> -- we are in process of connecting to a peer;</li>
<li><strong>Connected</strong> -- we have sent a handshake and are waiting for a response handshake;</li>
<li><strong>Ready</strong> -- we are exchanging domain-specific messages with the peer, like block announcements, gossip, etc;</li>
<li><strong>Incoming</strong> -- someone, we do not know who, has established a incoming connection with us. We are waiting for a handshake;</li>
</ul>
<p>Here is an example of Alice establishing connection with a boot node, Bob.</p>
<div class="mermaid">
sequenceDiagram
    Note over Alice: Alice has Bob's state as Unconnected
    Alice->>Alice: Connection timeout expires
    Note over Alice: Alice switches Bob's state to Connecting
    Alice->>+Bob: Opening connection
    Note over Alice,Bob: Bob adds a peer with the state Incoming. Alice switches Bob's state to Connected
    Alice->>Bob: Sending handshake
    Note over Bob: Bob switches Alice's state to Ready.
    Bob->>-Alice: Replying with handshake
    Note over Alice: Alice switches Bob's state to Ready.
</div>
<a class="header" href="#transaction-propagation" id="transaction-propagation"><h1>Transaction propagation</h1></a>
<p>It is essential for all nodes participating in the network having well synchronized their sets of unused transactions, and have an efficient mechanism to propagate them without decreasing transactions throughput. When a transaction is included in a block, every participant should forget(remove) this transaction.</p>
<a class="header" href="#strategies" id="strategies"><h2>Strategies</h2></a>
<ul>
<li>
<p>Dummy Strategy: Each participant has the set of transactions of every other participant from its point of view. This set is always a subset of the real set of transactions. When Alice and Bob want to sync their transactions, Alice will only send to Bob tx that she believes he doesn't have. After sending the transactions she will update her believes from Bob set.</p>
<ul>
<li>PRO: It is easy to implement. <strong>(We will use this strategy for alphanet)</strong></li>
<li>CONS: We are sending the same transactions many times overloading the network.</li>
<li>Details: Instead of keeping a set per participant explicitly, we will add a bitmask to each transaction of size the number of participants in the network. (What if participants goes in-n-out?)</li>
</ul>
</li>
<li>
<p>Bloom Filters:</p>
</li>
<li>
<p><a href="https://medium.com/harmony-one/block-syncing-in-1-36s-with-harmonys-adaptive-ida-protocol-de5da398569e">Block Syncing in 1.36s with Harmony’s Adaptive IDA Protocol</a></p>
</li>
</ul>
<a class="header" href="#nightshade" id="nightshade"><h1>Nightshade</h1></a>
<p><strong>Nightshade</strong> is the core algorithm of <em>NEAR-Blockchain</em> that allows a set of participants achieve consensus on byzantine environment. <strong>Nightshade</strong> tolerates up to 1 / 3 (not inclusive) of participants having byzantine behaviour.</p>
<a class="header" href="#the-prototocol" id="the-prototocol"><h2>The Prototocol</h2></a>
<p><strong>TODO</strong> Technical explanation of nightshade.</p>
<a class="header" href="#byzantine-behaviour" id="byzantine-behaviour"><h3>Byzantine behaviour</h3></a>
<ul>
<li>Failing in unexpected ways. <em>This is not penalized</em>. It is expected that nodes go in-n-out of the network at will, and network failures might occur.</li>
<li>Deviating from the protocol. <em>This should be penalized whenever detected and concrete evidence exists</em>.</li>
</ul>
<a class="header" href="#state-errors" id="state-errors"><h1>State errors</h1></a>
<p>This cover all possible way in which a state verification might fail. If the verification fails the participant sending this state must be considered adversarial (since he signs the gossip containing this state).</p>
<pre><code class="language-rust ignored">pub enum NSVerifyErr {
    // Bad formed triplet. Primary confidence must be equal or greater than secondary confidence.
    // Both confidence must be non negative integers.
    InvalidTriplet,
    // Bls signature provided doesn't match against bls public key + triplet data
    InvalidBlsSignature,
    // Proof doesn't contain enough signatures to increase confidence
    MissingSignatures,
    // Proofs provided are incorrect. Aggregated signature doesn't match with aggregated public keys + triplet data
    InvalidProof,
    // The proof for the current triplet is wrong. Confidence/Outcomes are not valid.
    InconsistentState,
    // There is a proof for a triplet that doesn't require it.
    ExtraProof,
    // Triplet requires a proof that is not present
    MissingProof,
}
</code></pre>
<a class="header" href="#cryptography" id="cryptography"><h1>Cryptography</h1></a>
<p>Participant should sign every message they sent through the network using its public key.</p>
<ul>
<li><a href="https://github.com/exonum/exonum_sodiumoxide">ed25519</a> signature is used for gossips, it is very fast signing/verifying.</li>
<li><a href="https://en.wikipedia.org/wiki/Boneh%E2%80%93Lynn%E2%80%93Shacham">BLS</a> to sign triplets inside Nigthshade Consensus.
<ul>
<li>Useful because it allow us to run a <a href="https://en.wikipedia.org/wiki/Threshold_cryptosystem">threshold scheme</a>.</li>
<li>Slow signing/verifying.</li>
</ul>
</li>
</ul>
<a class="header" href="#data-structures" id="data-structures"><h1>Data Structures</h1></a>
<p>The following is a list of standard data-structures.</p>
<a class="header" href="#transaction" id="transaction"><h2>Transaction</h2></a>
<pre><code class="language-rust ignored">struct Transaction {
    originator: AccountId,
    receiver: AccountId,
    nonce: u64,
    method_name: Vec&lt;u8&gt;,
    args: Vec&lt;u8&gt;,
    amount: Balance,
}

struct ReceiptBlock {
    header: SignedShardBlockHeader,
    path: Vec&lt;Hash&gt;,
    receipts: Vec&lt;Receipt&gt;,
}
</code></pre>
<a class="header" href="#shard" id="shard"><h2>Shard</h2></a>
<pre><code class="language-rust ignored">struct ShardBlockHeader {
    parent: Hash,
    index: u64,
    shard_id: u64,
    // State trie
    merkle_root_state: Hash,
    // Transactions Trie
    merkle_root_tx: Hash,
    // Receipt blocks Trie
    merkle_root_receipt: Hash,
    // Transaction result Trie
    merkle_root_tx_result: Hash,
    // Receipt result Trie
    merkle_root_receipt_result: Hash,
}

struct tShardBlockBody {
    receipts: Vec&lt;ReceiptBlock&gt;,
    transactions: Vec&lt;SignedTransaction&gt;,
}

struct SignedShardBlock {
    header: ShardHeader,
    body: ShardBody,
    signature: BLS,
    authority_mask: Vec&lt;bool&gt;,
}

// ShardBlock Extra (Index?)
// 	TransactionAddress
// 		BlockId
// 		Index
// 	Receipts
// 		HashMap&lt;ShardId, Vec&lt;Receipt&gt;&gt;
// 	Hash -&gt; Transaction/Receipt Result // or should we put into two Vec that align with transactions/receipts?
// 		Status (Completed, Failed)
// 		Gas
// 		Receipts ids of receipts
// 		Logs


struct ShardClient {
    chain: Chain&lt;SignedShardBlock&gt;,
    runtime: Runtime,
    state: StateDb,
}
    
fn to_shard_receipt_blocks(ShardBlockExtra) -&gt; Vec&lt;ReceiptBlock&gt; { 
   
}
</code></pre>
<a class="header" href="#beacon" id="beacon"><h2>Beacon</h2></a>
<pre><code class="language-rust ignored">//System extension to every contract/account
//	send_money(to, value)
//	swap_keys(old_public_key, new_public_key)
//
//Transaction(orignator=me, receiver=account, method=”system::swap_keys”, args={...})
//
//Transaction(originator=me, receiver=system, method=send_money, args={...})
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="mermaid.min.js"></script>
        
        <script type="text/javascript" src="mermaid-init.js"></script>
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
