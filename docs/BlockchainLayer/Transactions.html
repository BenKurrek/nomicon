<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Transactions - The Nearnomicon</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Implementation details of the NearProtocol client">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="../index.html">Introduction</a></li><li class="expanded "><a href="../BlockchainLayerVsRuntimeLayer.html"><strong aria-hidden="true">1.</strong> Blockchain Layer vs Runtime Layer</a></li><li class="expanded "><a href="../BlockchainLayer/BlockchainLayer.html"><strong aria-hidden="true">2.</strong> Blockchain Layer</a></li><li><ol class="section"><li class="expanded "><a href="../BlockchainLayer/Transactions.html" class="active"><strong aria-hidden="true">2.1.</strong> Transactions</a></li></ol></li><li class="expanded "><a href="../Runtime/Runtime.html"><strong aria-hidden="true">3.</strong> Runtime</a></li><li><ol class="section"><li class="expanded "><a href="../Runtime/Scenarios/Scenarios.html"><strong aria-hidden="true">3.1.</strong> Scenarios</a></li><li><ol class="section"><li class="expanded "><a href="../Runtime/Scenarios/FinancialTransaction.html"><strong aria-hidden="true">3.1.1.</strong> Financial Transaction</a></li><li class="expanded "><a href="../Runtime/Scenarios/CrossContractCall.html"><strong aria-hidden="true">3.1.2.</strong> Cross-Contract Call</a></li></ol></li><li class="expanded "><a href="../Runtime/Components/Components.html"><strong aria-hidden="true">3.2.</strong> Components</a></li><li><ol class="section"><li class="expanded "><a href="../Runtime/Components/RuntimeCrate.html"><strong aria-hidden="true">3.2.1.</strong> Runtime crate</a></li><li class="expanded "><a href="../Runtime/Components/BindingsSpec/BindingsSpec.html"><strong aria-hidden="true">3.2.2.</strong> Bindings Specification</a></li><li><ol class="section"><li class="expanded "><a href="../Runtime/Components/BindingsSpec/RegistersAPI.html"><strong aria-hidden="true">3.2.2.1.</strong> Registers API</a></li><li class="expanded "><a href="../Runtime/Components/BindingsSpec/TrieAPI.html"><strong aria-hidden="true">3.2.2.2.</strong> Trie API</a></li><li class="expanded "><a href="../Runtime/Components/BindingsSpec/PromisesAPI.html"><strong aria-hidden="true">3.2.2.3.</strong> Promises API</a></li><li class="expanded "><a href="../Runtime/Components/BindingsSpec/ContextAPI.html"><strong aria-hidden="true">3.2.2.4.</strong> Context API</a></li><li class="expanded "><a href="../Runtime/Components/BindingsSpec/EconomicsAPI.html"><strong aria-hidden="true">3.2.2.5.</strong> Economics API</a></li><li class="expanded "><a href="../Runtime/Components/BindingsSpec/MathAPI.html"><strong aria-hidden="true">3.2.2.6.</strong> Math API</a></li><li class="expanded "><a href="../Runtime/Components/BindingsSpec/MiscellaneousAPI.html"><strong aria-hidden="true">3.2.2.7.</strong> Miscellaneous API</a></li></ol></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Nearnomicon</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#transactions" id="transactions">Transactions</a></h1>
<p>A client creates a transaction, computes the transaction hash and signs this hash to get a signed transaction.
Now this signed transaction can be sent to a node.</p>
<p>When a node receives a new signed transaction, it validates the transaction (if the node tracks the shard) and gossips it to the peers. Eventually, the valid transaction is added to a transaction pool.</p>
<p>Every validating node has its own transaction pool. The transaction pool maintains transactions that were not yet discarded and not yet included into the chain.</p>
<p>Before producing a chunk transactions are ordered and validated again. This is done to produce chunks with only valid transactions.</p>
<h2><a class="header" href="#transaction-ordering" id="transaction-ordering">Transaction ordering</a></h2>
<p>The transaction pool groups transactions by a pair of <code>(signer_id, signer_public_key)</code>. The <code>signer_id</code> is the account ID of the user who signed the transaction, the <code>signer_public_key</code> is the public key of the account's access key that was used to sign the transactions. 
Within the group, the transactions are ordered by nonce in non-decreasing order.</p>
<p>The valid order of the transactions is the following:</p>
<ul>
<li>transactions are ordered in batches.</li>
<li>each batch should contain exactly one transaction with the lowest nonce for every transaction group keyed by the pair of <code>(signer_id, signer_public_key)</code>.</li>
<li>the order within a batch is undefined and each node should use a unique secret seed for that ordering.</li>
</ul>
<p>Transaction pool provides a draining structure that allows to select valid transactions in a proper order.</p>
<h2><a class="header" href="#transaction-validation" id="transaction-validation">Transaction validation</a></h2>
<p>The transaction validation happens twice, once before adding to the transaction pool, next before adding to a chunk.</p>
<h3><a class="header" href="#before-adding-to-a-transaction-pool" id="before-adding-to-a-transaction-pool">Before adding to a transaction pool</a></h3>
<p>This is done to quickly filter out transactions that have an invalid signature or are invalid on the latest state.</p>
<h3><a class="header" href="#before-adding-to-a-chunk" id="before-adding-to-a-chunk">Before adding to a chunk</a></h3>
<p>A chunk producer pulls ordered transactions from the transaction pool using a draining structure.
Transactions are pulled from the the pool and validated one by one on top of latest state. The state is persisted after each successful validation.
E.g. if the first transaction charged the account, the next transaction for the same account may become invalid.</p>
<p>If the last transaction was invalid, the chunk producer requests the next transaction from the pool with the same key to maintain the proper order.
Otherwise we'd skip this key pair within this batch and the order will become invalid.</p>
<p>Valid transactions are added to the chunk. For every valid transaction, the validation result contains the amount of burnt gas that will be charged for converting this
transaction to a receipt. When the total sum of burnt gas for valid transactions exceeds the gas limit of a chunk, the chunk 
producer drops the draining iterator and the remaining transactions stay in the pool.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../BlockchainLayer/BlockchainLayer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../Runtime/Runtime.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../BlockchainLayer/BlockchainLayer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../Runtime/Runtime.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
